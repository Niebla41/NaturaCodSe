<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador de Códigos Secuenciales Natura</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --natura-green: #1a7d3d;
        --natura-light-green: #8bc34a;
        --natura-beige: #f5f3e4;
        --natura-brown: #604c3f;
      }

      body {
        background-color: var(--natura-beige);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .header {
        background-color: var(--natura-green);
        color: white;
        padding: 1rem;
        margin-bottom: 2rem;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-weight: bold;
      }

      .main-container {
        background-color: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .form-label {
        font-weight: 600;
        color: var(--natura-brown);
      }

      .btn-natura {
        background-color: var(--natura-green);
        color: white;
        border: none;
        transition: all 0.3s;
      }

      .btn-natura:hover {
        background-color: #125d2d;
        color: white;
      }

      .result-box {
        background-color: var(--natura-beige);
        border: 2px solid var(--natura-light-green);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1.5rem;
        font-size: 1.2rem;
        font-weight: bold;
      }

      .sequential-code-display {
        font-family: "Courier New", monospace;
        font-size: 2rem;
        font-weight: bold;
      }

      .timer-display {
        font-family: monospace;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--natura-brown);
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 0.5rem 1rem;
        text-align: center;
      }

      .section-title {
        color: var(--natura-green);
        border-bottom: 2px solid var(--natura-light-green);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .btn-export {
        background-color: var(--natura-brown);
        color: white;
      }

      .search-container {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="text-center py-3">
        <img
          src="https://imgs.search.brave.com/oFQDkNcZtmVYbv2oCzrI4S7GWmeDV470JO3e6AvYB8c/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9sb2dv/ZG93bmxvYWQub3Jn/L3dwLWNvbnRlbnQv/dXBsb2Fkcy8yMDE0/LzA1L25hdHVyYS1s/b2dvLTQtMS5wbmc"
          class="mb-2"
          alt="Logo Natura"
        />
      </div>

      <div class="container">
        <div class="d-flex align-items-center justify-content-center">
          <h1>Generador de Códigos Secuenciales Natura</h1>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="main-container">
        <h2 class="section-title">Generación de Código</h2>

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="currentYear" class="form-label">Año Actual:</label>
              <input
                type="text"
                class="form-control"
                id="currentYear"
                readonly
              />
            </div>

            <div class="mb-3">
              <label for="monthSelect" class="form-label"
                >Mes de Fabricación:</label
              >
              <select class="form-select" id="monthSelect">
                <option value="1">Enero (1)</option>
                <option value="2">Febrero (2)</option>
                <option value="3">Marzo (3)</option>
                <option value="4">Abril (4)</option>
                <option value="5">Mayo (5)</option>
                <option value="6">Junio (6)</option>
                <option value="7">Julio (7)</option>
                <option value="8">Agosto (8)</option>
                <option value="9">Septiembre (9)</option>
                <option value="A">Octubre (A)</option>
                <option value="B">Noviembre (B)</option>
                <option value="C">Diciembre (C)</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="productCode" class="form-label"
                >Código de Producto:</label
              >
              <input
                type="text"
                class="form-control"
                id="productCode"
                placeholder="Ingrese el código del producto"
              />
            </div>

            <div class="mb-3">
              <label for="productDescription" class="form-label"
                >Descripción del Producto:</label
              >
              <input
                type="text"
                class="form-control"
                id="productDescription"
                readonly
              />
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label for="sequentialCode" class="form-label"
                >Código Secuencial Generado:</label
              >
              <div id="sequentialCode" class="result-box text-center">
                <span class="sequential-code-display">L.A1XM01</span>
              </div>
            </div>

            <div class="mb-3 mt-4">
              <label for="timerDisplay" class="form-label"
                >Tiempo Activo:</label
              >
              <div id="timerDisplay" class="timer-display">00:00:00</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Opciones:</label>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="options"
                  id="optionChangeOrder"
                  value="cambioOrden"
                />
                <label class="form-check-label" for="optionChangeOrder">
                  Cambio de Orden
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="options"
                  id="optionGenerate"
                  value="generarSecuencial"
                  checked
                />
                <label class="form-check-label" for="optionGenerate">
                  Generar Secuencial
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="options"
                  id="optionChangeBatch"
                  value="cambioBatch"
                />
                <label class="form-check-label" for="optionChangeBatch">
                  Cambio de Batch
                </label>
              </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
              <button id="startButton" class="btn btn-natura btn-lg me-md-2">
                <i class="fas fa-play me-2"></i>Iniciar
              </button>
              <button id="stopButton" class="btn btn-danger btn-lg" disabled>
                <i class="fas fa-stop me-2"></i>Terminar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Registro de Actividad -->
      <div class="main-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="section-title mb-0">Registro de Actividad</h3>
          <div>
            <button id="exportButton" class="btn btn-export me-2">
              <i class="fas fa-file-export me-2"></i>Exportar
            </button>
            <button id="clearButton" class="btn btn-danger">
              <i class="fas fa-trash me-2"></i>Limpiar
            </button>
          </div>
        </div>

        <!-- Buscador de códigos por producto -->
        <div class="search-container">
          <div class="row">
            <div class="col-md-6">
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="searchProductCode"
                  class="form-control"
                  placeholder="Buscar por código de producto"
                />
                <button class="btn btn-natura" type="button" id="searchButton">
                  <i class="fas fa-search"></i> Buscar
                </button>
                <button
                  class="btn btn-secondary"
                  type="button"
                  id="clearSearchButton"
                >
                  <i class="fas fa-times"></i> Limpiar
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped" id="activityTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Código</th>
                <th>Producto</th>
                <th>Tiempo Activo</th>
                <th>Opción</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Los registros se agregarán aquí dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="bg-light py-3 mt-5">
      <div class="container text-center">
        <p class="mb-0">
          © 2025 Sistema Generador de Códigos Secuenciales Natura
        </p>
      </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      // Base de datos de productos con número de serie, nombre y descripción
      const productDatabase = {
        P001: {
          serialNumber: "SN-001-2025",
          name: "Crema Hidratante Ekos",
          description:
            "Crema hidratante con ingredientes naturales de la línea Ekos",
        },
        P002: {
          serialNumber: "SN-002-2025",
          name: "Perfume Kaiak",
          description:
            "Perfume masculino de la línea Kaiak con fragancia fresca",
        },
        P003: {
          serialNumber: "SN-003-2025",
          name: "Jabón Tododia",
          description: "Jabón líquido de la línea Tododia con aroma a coco",
        },
        P004: {
          serialNumber: "SN-004-2025",
          name: "Shampoo Lumina",
          description: "Shampoo para cabellos rubios de la línea Lumina",
        },
        P005: {
          serialNumber: "SN-005-2025",
          name: "Aceite Corporal Sève",
          description: "Aceite corporal nutritivo de la línea Sève",
        },
        P006: {
          serialNumber: "SN-006-2025",
          name: "Labial Una",
          description: "Labial hidratante de la línea Una con color natural",
        },
        P007: {
          serialNumber: "SN-007-2025",
          name: "Desodorante Erva Doce",
          description: "Desodorante roll-on de la línea Erva Doce",
        },
        P008: {
          serialNumber: "SN-008-2025",
          name: "Crema Anti-señales Chronos",
          description: "Crema anti-edad de la línea Chronos",
        },
        P009: {
          serialNumber: "SN-009-2025",
          name: "Agua de Colonia Humor",
          description: "Agua de colonia infantil de la línea Humor",
        },
        P010: {
          serialNumber: "SN-010-2025",
          name: "Hidratante Facial Faces",
          description:
            "Hidratante facial para todo tipo de piel de la línea Faces",
        },
      };

      // Función para buscar un producto por código
      function getProductByCode(code) {
        return productDatabase[code] || null;
      }

      // Variables globales
      let timerInterval;
      let startTime;
      let isRunning = false;
      let yearLetter = "A";
      let currentMonth = "";
      let currentProduct = "";
      let db;

      // Elementos del DOM
      const currentYearElem = document.getElementById("currentYear");
      const monthSelectElem = document.getElementById("monthSelect");
      const productCodeElem = document.getElementById("productCode");
      const productDescriptionElem =
        document.getElementById("productDescription");
      const sequentialCodeElem = document.getElementById("sequentialCode");
      const timerDisplayElem = document.getElementById("timerDisplay");
      const startButtonElem = document.getElementById("startButton");
      const stopButtonElem = document.getElementById("stopButton");
      const activityTableElem = document
        .getElementById("activityTable")
        .getElementsByTagName("tbody")[0];
      const exportButton = document.getElementById("exportButton");
      const clearButton = document.getElementById("clearButton");
      const searchProductCodeElem =
        document.getElementById("searchProductCode");
      const searchButtonElem = document.getElementById("searchButton");
      const clearSearchButtonElem =
        document.getElementById("clearSearchButton");

      // Inicializar la base de datos IndexedDB
      function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("NaturaSequentialDB", 2);

          request.onerror = (event) => {
            console.error("Error al abrir la base de datos", event);
            reject("Error al abrir la base de datos");
          };

          request.onsuccess = (event) => {
            db = event.target.result;
            console.log("Base de datos abierta con éxito");
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // Crear almacén para actividades
            const activitiesStore = db.createObjectStore("activities", {
              keyPath: "id",
              autoIncrement: true,
            });

            // Crear índices para actividades
            activitiesStore.createIndex("by_date", "timestamp");
            activitiesStore.createIndex("by_month_product", [
              "month",
              "productCode",
            ]);
            activitiesStore.createIndex("by_product", "productCode");

            // Crear almacén para productos (si quieres guardar productos localmente)
            const productsStore = db.createObjectStore("products", {
              keyPath: "code",
            });

            // Crear índices para productos
            productsStore.createIndex("by_serial", "serialNumber");
            productsStore.createIndex("by_name", "name");

            console.log("Estructura de la base de datos creada");
          };
        });
      }

      // Establecer el año actual
      function setCurrentYear() {
        const today = new Date();
        const year = today.getFullYear();
        currentYearElem.value = year.toString();

        // Calcular la letra del año actual (2025=A, 2026=B, ..., 2049=Z)
        const baseYear = 2025;
        const yearDiff = year - baseYear;

        if (yearDiff >= 0 && yearDiff <= 24) {
          yearLetter = String.fromCharCode(65 + yearDiff);
        } else {
          yearLetter = "?";
        }

        // Establecer mes actual
        const month = today.getMonth() + 1;
        if (month <= 9) {
          monthSelectElem.value = String(month);
        } else if (month === 10) {
          monthSelectElem.value = "A";
        } else if (month === 11) {
          monthSelectElem.value = "B";
        } else if (month === 12) {
          monthSelectElem.value = "C";
        }

        currentMonth = monthSelectElem.value;
        updateSequentialCode();
      }

      // Buscar descripción del producto
      productCodeElem.addEventListener("input", function () {
        const code = this.value.trim().toUpperCase();
        const product = getProductByCode(code);

        if (product) {
          productDescriptionElem.value = `${product.name} - ${product.description}`;
        } else {
          productDescriptionElem.value = "";
        }

        currentProduct = code;
        updateSequentialCode();
      });

      // Obtener el siguiente número secuencial basado en mes y producto
      async function getNextSequential(month, product) {
        if (!month || !product) return 1;

        const transaction = db.transaction(["activities"], "readonly");
        const store = transaction.objectStore("activities");
        const index = store.index("by_month_product");
        const request = index.getAll([month, product]);

        return new Promise((resolve) => {
          request.onsuccess = (event) => {
            const records = event.target.result;
            if (records.length > 0) {
              // Encontrar el máximo número secuencial para este mes-producto
              let maxNumber = 0;
              records.forEach((record) => {
                const number = parseInt(record.code.slice(-2));
                if (number > maxNumber) maxNumber = number;
              });
              resolve(maxNumber + 1);
            } else {
              resolve(1);
            }
          };

          request.onerror = () => resolve(1);
        });
      }

      // Actualizar código secuencial
      async function updateSequentialCode() {
        const month = monthSelectElem.value;

        if (month !== currentMonth) {
          currentMonth = month;
        }

        if (currentProduct) {
          const sequential = String(
            await getNextSequential(month, currentProduct)
          ).padStart(2, "0");
          sequentialCodeElem.querySelector(
            ".sequential-code-display"
          ).textContent = `L.${yearLetter}${month}XM${sequential}`;
        } else {
          sequentialCodeElem.querySelector(
            ".sequential-code-display"
          ).textContent = `L.${yearLetter}${month}XM01`;
        }
      }

      // Guardar actividad en la base de datos
      function saveActivity(activity) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["activities"], "readwrite");
          const store = transaction.objectStore("activities");
          const request = store.add(activity);

          request.onsuccess = () => {
            console.log("Actividad guardada");
            resolve();
          };

          request.onerror = (event) => {
            console.error("Error al guardar actividad", event);
            reject("Error al guardar actividad");
          };
        });
      }

      // Cargar actividades desde la base de datos
      function loadActivities(productCode = null) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["activities"], "readonly");
          const store = transaction.objectStore("activities");
          let request;

          if (productCode) {
            const index = store.index("by_product");
            request = index.getAll(productCode);
          } else {
            const index = store.index("by_date");
            request = index.getAll();
          }

          request.onsuccess = (event) => {
            const activities = event.target.result;
            resolve(activities);
          };

          request.onerror = (event) => {
            console.error("Error al cargar actividades", event);
            reject("Error al cargar actividades");
          };
        });
      }

      // Actualizar tabla de actividades
      async function updateActivityTable(productCode = null) {
        try {
          const activities = await loadActivities(productCode);
          activityTableElem.innerHTML = "";

          activities
            .sort((a, b) => b.timestamp - a.timestamp)
            .forEach((activity) => {
              const row = activityTableElem.insertRow();

              const cell1 = row.insertCell(0);
              cell1.textContent = activity.date;

              const cell2 = row.insertCell(1);
              cell2.textContent = activity.time;

              const cell3 = row.insertCell(2);
              cell3.textContent = activity.code;

              const cell4 = row.insertCell(3);
              cell4.textContent = activity.product;

              const cell5 = row.insertCell(4);
              cell5.textContent = activity.duration;

              const cell6 = row.insertCell(5);
              cell6.textContent = activity.option;

              const cell7 = row.insertCell(6);
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "btn btn-sm btn-danger";
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.onclick = () => deleteActivity(activity.id);
              cell7.appendChild(deleteBtn);
            });
        } catch (error) {
          console.error("Error al actualizar tabla:", error);
        }
      }

      // Eliminar actividad
      function deleteActivity(id) {
        if (confirm("¿Está seguro de eliminar este registro?")) {
          const transaction = db.transaction(["activities"], "readwrite");
          const store = transaction.objectStore("activities");
          const request = store.delete(id);

          request.onsuccess = () => {
            console.log("Actividad eliminada");
            updateActivityTable();
            updateSequentialCode();
          };

          request.onerror = (event) => {
            console.error("Error al eliminar actividad", event);
          };
        }
      }

      // Exportar datos a CSV
      function exportToCSV() {
        loadActivities().then((activities) => {
          if (activities.length === 0) {
            alert("No hay datos para exportar");
            return;
          }

          // Crear contenido CSV
          let csvContent = "data:text/csv;charset=utf-8,";
          csvContent += "Fecha,Hora,Código,Producto,Tiempo Activo,Opción\n";

          activities.forEach((activity) => {
            csvContent += `"${activity.date}","${activity.time}","${activity.code}","${activity.product}","${activity.duration}","${activity.option}"\n`;
          });

          // Crear enlace de descarga
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute(
            "download",
            `registros_natura_${new Date().toISOString().slice(0, 10)}.csv`
          );
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }

      // Limpiar todos los registros
      function clearAllActivities() {
        if (
          confirm(
            "¿Está seguro de eliminar TODOS los registros? Esta acción no se puede deshacer."
          )
        ) {
          const transaction = db.transaction(["activities"], "readwrite");
          const store = transaction.objectStore("activities");
          const request = store.clear();

          request.onsuccess = () => {
            console.log("Todos los registros eliminados");
            updateActivityTable();
            updateSequentialCode();
          };

          request.onerror = (event) => {
            console.error("Error al limpiar registros", event);
          };
        }
      }

      // Iniciar timer
      function startTimer() {
        if (isRunning) return;

        if (!currentProduct) {
          alert("Por favor, ingrese un código de producto válido.");
          return;
        }

        isRunning = true;
        startTime = new Date();
        timerInterval = setInterval(updateTimer, 1000);

        startButtonElem.disabled = true;
        stopButtonElem.disabled = false;
        productCodeElem.disabled = true;
        monthSelectElem.disabled = true;
      }

      // Actualizar timer
      function updateTimer() {
        const now = new Date();
        const diff = now - startTime;

        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        timerDisplayElem.textContent = `${String(hours).padStart(
          2,
          "0"
        )}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(
          2,
          "0"
        )}`;
      }

      // Detener timer y registrar actividad
      async function stopTimer() {
        if (!isRunning) return;

        clearInterval(timerInterval);

        // Obtener la opción seleccionada
        const selectedOption = document.querySelector(
          'input[name="options"]:checked'
        ).value;
        let optionText = "";

        switch (selectedOption) {
          case "cambioOrden":
            optionText = "Cambio de Orden";
            break;
          case "generarSecuencial":
            optionText = "Generar Secuencial";
            break;
          case "cambioBatch":
            optionText = "Cambio de Batch";
            break;
        }

        // Obtener el número secuencial actual
        const sequential = String(
          await getNextSequential(currentMonth, currentProduct)
        ).padStart(2, "0");
        const code = `L.${yearLetter}${currentMonth}XM${sequential}`;

        // Crear objeto de registro
        const now = new Date();
        const activity = {
          timestamp: now.getTime(),
          date: now.toLocaleDateString(),
          time: now.toLocaleTimeString(),
          code: code,
          product: productDescriptionElem.value,
          duration: timerDisplayElem.textContent,
          option: optionText,
          month: currentMonth,
          productCode: currentProduct,
        };

        try {
          await saveActivity(activity);
          await updateActivityTable();

          // Resetear el timer y actualizar UI
          timerDisplayElem.textContent = "00:00:00";
          isRunning = false;
          startButtonElem.disabled = false;
          stopButtonElem.disabled = true;
          productCodeElem.disabled = false;
          monthSelectElem.disabled = false;

          // Actualizar el código secuencial para el próximo uso
          updateSequentialCode();
        } catch (error) {
          console.error("Error al guardar actividad:", error);
          alert("Ocurrió un error al guardar el registro");
        }
      }

      // Event listeners
      startButtonElem.addEventListener("click", startTimer);
      stopButtonElem.addEventListener("click", stopTimer);
      monthSelectElem.addEventListener("change", updateSequentialCode);
      exportButton.addEventListener("click", exportToCSV);
      clearButton.addEventListener("click", clearAllActivities);

      // Buscar registros por código de producto
      searchButtonElem.addEventListener("click", function () {
        const productCode = searchProductCodeElem.value.trim().toUpperCase();
        if (productCode) {
          updateActivityTable(productCode);
        } else {
          alert("Por favor ingrese un código de producto para buscar");
        }
      });

      // Limpiar búsqueda
      clearSearchButtonElem.addEventListener("click", function () {
        searchProductCodeElem.value = "";
        updateActivityTable();
      });

      // Inicializar la aplicación
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          await initDB();
          setCurrentYear();
          await updateActivityTable();
          await updateSequentialCode();
        } catch (error) {
          console.error("Error al inicializar la aplicación:", error);
          alert("Ocurrió un error al inicializar la aplicación");
        }
      });
    </script>
  </body>
</html>
